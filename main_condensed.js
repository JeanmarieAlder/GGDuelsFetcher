const selfId = ""
const lastId = ""
async function main(e,t){function n(e,t){return new Promise(n=>{setTimeout(()=>{n(e())},t)})}function o(e){return[...e.matchAll(/\\"gameId\\":\\"([\w\d\-]*)\\",\\"gameMode\\":\\"Duels\\"/g)].map(e=>e[1])}function r(t){return btoa(`{"HashKey":{"S":"${e+"_activity"}"},"Created":{"S":"${t}"}}`)}async function a(e=1,t="",a=""){let p=a,l=[];for(let s=0;s<e;s++){console.log("Fetching page",s+1);let i="https://www.geoguessr.com/api/v4/feed/private";""!==p&&(i+="?paginationToken="+p);let u=await (await fetch(i)).json();if(0===u.entries.length){console.log("All data fetched.");break}if(l.push(...o(JSON.stringify(u))),l.includes(t))break;p=r(u.entries[u.entries.length-1].time.substring(0,23)+"Z"),await n(()=>console.log("Done"),500)}let d=l.filter((e,t,n)=>n.indexOf(e)===t);return d.includes(t)?d.slice(0,d.indexOf(t)):d}let p=await a(1e3,t),l={};async function s(t){let n={};n.id=t.gameId,n.rounds=t.currentRoundNumber,n.startDate=new Date(t.rounds[0].startTime).toLocaleString("en-US"),n.endDate=new Date(t.rounds[n.rounds-1].endTime).toLocaleString("en-US"),n.mode=t.options.competitiveGameMode;for(let o=0;o<2;o++){let r=t.teams[o];if(r.players[0].playerId===e){if(n.selfHp=r.health,null===r.players[0].progressChange)n.befElo=r.players[0].rating,n.aftElo=n.befElo;else{let a=r.players[0].progressChange.competitiveProgress;null===a?(n.befElo=r.players[0].rating,n.aftElo=n.befElo):(n.befElo=a.ratingBefore,n.aftElo=a.ratingAfter)}[n.selfDist,n.selfTtg,n.selfCountries]=i(r.players[0].guesses,t.rounds,r.roundResults,t.teams[1-o].roundResults)}else{if(n.oppId=r.players[0].playerId,n.oppHp=r.health,n.oppElo=r.players[0].rating,[n.oppDist,n.oppTtg,_nil]=i(r.players[0].guesses,t.rounds),!l[n.oppId]){let p=`https://www.geoguessr.com/api/v3/users/${n.oppId}`,s=await fetch(p,{credentials:"include"});if(s.status>=400){n.oppName="Deleted User",n.oppCountry="",n.oppBanned=!0,n.oppBlueCheck=!1,n.oppCreator=!1;continue}let u=await s.json();l[n.oppId]=u}let d=l[n.oppId];n.oppName=d.nick,n.oppCountry=d.countryCode,n.oppBanned=d.isBanned,n.oppBluecheck=(2&d.flair)!=0,n.oppCreator=d.isCreator}}return n}function i(e,t,n=null,o=null){let r=0,a=0,p=0,l={};for(let s of e){let i=s.roundNumber-1,u=(new Date(s.created)-new Date(t[i].startTime))/1e3;if(p++,r+=s.distance,a+=u,!n)continue;let d=t[i].panorama?.countryCode;""!==d&&(d in l||(l[d]=[0,0,0,0,0,0]),l[d][0]++,l[d][1]+=s.distance,l[d][2]+=u,n[i].healthAfter>=n[i].healthBefore?l[d][3]++:l[d][4]+=o[i].score-n[i].score,l[d][5]+=n[i].score-o[i].score)}return 0===p?["",""]:[r/p,a/p,Object.entries(l).map(e=>e[0]+","+e[1].join(",")).join(";")]}async function u(e){let t=[],o=0;for(let r of e){console.log(`Fetching duel #${o++} / ${e.length}`);try{let a=await fetch(`https://game-server.geoguessr.com/api/duels/${r}`,{credentials:"include"});a=await a.json();let p=await s(a);t.push(p),await n(()=>null,150)}catch(l){console.log(`Error fetching duel ${r}`)}}return t}let d={id:"ID",rounds:"# Rounds",startDate:"Start Date",endDate:"End Date",selfHp:"My Health",befElo:"Start ELO",aftElo:"End ELO",selfDist:"Avg Distance",selfTtg:"Avg TTG",oppId:"Opp ID",oppHp:"Opp Health",oppElo:"Opp ELO",oppDist:"Opp Distance",oppTtg:"Opp TTG",selfCountries:"Self Countries",mode:"Game Mode",oppName:"Opp Name",oppCountry:"Opp Country",oppBanned:"Opp Banned",oppBluecheck:"Opp Bluecheck",oppCreator:"Opp Creator"},c=await u(p),f=function e(t,n="	",o=d){let r="";for(let a of t=[...t]){for(let p in o)r+=a[p]+n;r+="\n"}return r}(c);return f}
await main(selfId, lastId)
